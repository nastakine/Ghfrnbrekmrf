(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function _defineProperties(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var o=r.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}!function(){let e=function(){function e(){this.userInfo=this.$services.userData.userData,this.eventsModel=this.$services.notifications.eventsModel,this.ordersCount=null,this.deliveryInfo=null,this.newEventsCount=0,this.discountInfo=null,this.favoritesModel=null,this.favBrandsModel=null,this.ordersModel=null,this.balanceModel=null,this.discountModel=null,this.bankCardModel=null,this.wbCardBalance=0,this.lotteryEnabled=!1;const e=this.$services.cartService.publicBasketApiUrl;this.bankCardUrl=`${e}/webapi/lk/bankcards/selected`,this.extraInfoUrl=this.$router.getChildRouteByName("SpaPersonalCabinetGetExtraInfo").path,this.bindCardUrl=`${e}/webapi/lk/account/spa/bindnewcard`,this.externalIdentityClosed=this.userInfo.isUnknownUser||!wb.global.settings.switches.enableTinkoffIdentification||this.userInfo.isIdentityVerified||wb.global.userSettings.closed.includes("ext_id_prof_home"),this.externalIdentityClosed||(wb.global.userSettings.closed.push("ext_id_prof_home"),wb.global.saveUserSettings()),this.showFavoritesGoods=this.$helper.throttle(this.showFavoritesGoods.bind(this),100)}var t=e.prototype;return t.onAfterRender=async function(){const e=this._loadExtraInfo();this._loadBankCard(),this._loadDeliveryInfo(),this._loadUserDataAsync(),this._loadUserBalanceAsync(),this._loadFavGoodsAsync(),this._loadWbxArchive(e),this._checkLotteryAvailability(),this.externalIdentityClosed||this.$analitic.sendEvent("LK_Account_Confirmation_S",{type:"Tinkoff"})},t.onBeforeUnrender=function(){window.removeEventListener("resize",this.showFavoritesGoods)},t.showFavoritesGoods=function(){let e=7;const t=document.querySelectorAll(".j-favorites-list > li");if("m"===wb.settings.displayMode){const r=parseFloat(getComputedStyle(t[1]).width),o=parseFloat(getComputedStyle(t[1]).marginLeft),i=document.querySelector(".j-favorites-list").offsetWidth;e=Math.floor((i-r)/(r+o))}$.observable(this.favoritesModel.goods).refresh(this.favoritesModel.allGoods.slice(0,e))},t.getScreenName=function(){return"LK"},t.bindNewCard=function(e){this.bankCardModel.isNetworkError||null!=this.bankCardModel.selectedCard||(e.preventDefault(),this.$httpClient.fetchJSON(this.bindCardUrl,{method:"POST",credentials:"include",body:new URLSearchParams({paymentCode:"crd",returnUrl:`${window.location.href}?r=`})}).catch(e=>{e.isCustomError?wb.popup.renderModalError(e.message):(console.error(e),wb.popup.renderModalError("Неизвестная ошибка"))}))},t.formatCardNumber=function(e){return e.slice(-6)},t._loadDeliveryInfo=async function(){try{const e=await this.$services.groupedDeliveriesService.getOverview();$.observable(this).setProperty({deliveryInfo:null!=e?e:{cnt:0,isCacheEmpty:!0}})}catch(e){console.error(e),$.observable(this).setProperty({deliveryInfo:{isNetworkError:!0}})}},t._loadBankCard=async function(){let e;try{e={selectedCard:(await this.$httpClient.fetchJSON(this.bankCardUrl,{method:"POST",credentials:"include",body:new URLSearchParams({currency:WbSpaModel.prototype.$user.getCurrency()})})).selectedBankCard}}catch(t){e={isNetworkError:!0}}finally{return $.observable(this).setProperty({bankCardModel:e}),{bankCardModel:e}}},t._loadExtraInfo=async function(){let e,t;try{var r,o,i;const s=await this.$httpClient.fetchJSON(this.extraInfoUrl,{method:"POST"});e={count:null!==(r=s.favoriteBrandsCount)&&void 0!==r?r:0},t={count:null!==(o=null==s?void 0:s.ordersCount)&&void 0!==o?o:0,items:null!==(i=null==s?void 0:s.archiveGoods)&&void 0!==i?i:[]}}catch(r){e={isNetworkError:!0},t={isNetworkError:!0}}finally{return $.observable(this).setProperty({favBrandsModel:e}),{favBrandsModel:e,ordersModel:t}}},t._loadUserDataAsync=async function(){let e,t;try{const{userExtraInfo:r}=await this.$services.userData.getUserDataAsync(!0);e={isNetworkError:r.isNetworkError,dataLoaded:r.dataLoaded,...r.discountInfo},t=r.wbCardBalance}catch(r){console.log(r),e={isNetworkError:!0,dataLoaded:!1},t=null}finally{$.observable(this).setProperty({discountModel:e,wbCardBalance:t})}},t._loadUserBalanceAsync=async function(){try{const e=await this.$user.getBalance();$.observable(this).setProperty({balanceModel:e})}catch(e){$.observable(this).setProperty({balanceModel:{isNetworkError:!0}})}},t._loadFavGoodsAsync=async function(){let e;try{e=await this.$services.favsService.getSimplifiedModelAsync()}catch(t){e={isNetworkError:!0}}finally{var t;$.observable(this).setProperty({favoritesModel:e}),(null===(t=this.favoritesModel)||void 0===t?void 0:t.goods.length)>7&&(this.showFavoritesGoods(),window.addEventListener("resize",this.showFavoritesGoods))}},t._loadWbxArchive=async function(e){let t;try{if(await this.$user.getWbxId())try{var r;const o=await this.$services.groupedDeliveriesService.initWbxDeliveriesInfo();t={count:null==o?void 0:o.length,items:null!==(r=null==o?void 0:o.slice(0,7))&&void 0!==r?r:[]}}catch(r){t=(await e).ordersModel}t=(await e).ordersModel}catch(e){t={isNetworkError:!0}}finally{$.observable(this).setProperty({ordersModel:t})}},t._checkLotteryAvailability=async function(){try{const e=await this.$checkLotteryAvailabilityAsync();$.observable(this).setProperty({lotteryEnabled:e})}catch(e){console.error(e)}},_createClass(e,[{key:"deliveryDate",get:function(){return null==this.deliveryInfo||null==this.deliveryInfo.deliveryDate?null:{year:new Date(this.deliveryInfo.deliveryDate).getFullYear()}}},{key:"isDeliveryToday",get:function(){return new Date(this.deliveryInfo.deliveryDate).getDate()==(new Date).getDate()}},{key:"helpers",get:function(){return{showExternalIdentity:()=>{this.$moduleLoader.loadModuleAsync("externalIdentity").then(e=>new e("LK_Account_Confirmation_T").showPopup())}}}}]),e}();wb.spa.registerViewModel(e)}();

},{}]},{},[1]);
